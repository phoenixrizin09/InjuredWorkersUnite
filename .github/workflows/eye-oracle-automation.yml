# ğŸ‘ï¸ THE EYE ORACLE - Automated Investigation System
# 
# This workflow runs The Eye Oracle automated scans:
# - Hourly: Quick check for breaking news/data releases
# - Daily (6 AM ET): Full investigation and blog post generation
# - Weekly (Sunday 9 PM ET): Deep analysis and pattern detection
# - Monthly (1st of month): Comprehensive report generation
#
# The Eye sees all. The Eye speaks truth.

name: Eye Oracle Automation

on:
  # Scheduled runs
  schedule:
    # Hourly scan - every hour at minute 15
    - cron: '15 * * * *'
    # Daily scan - 6 AM ET (11:00 UTC)
    - cron: '0 11 * * *'
    # Weekly scan - Sunday 9 PM ET (Monday 2:00 UTC)
    - cron: '0 2 * * 1'
    # Monthly scan - 1st of month at 3 AM ET (8:00 UTC)
    - cron: '0 8 1 * *'
  
  # Manual trigger with type selection
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of scan to run'
        required: true
        default: 'daily'
        type: choice
        options:
          - hourly
          - daily
          - weekly
          - monthly
          - full

env:
  NODE_VERSION: '18'

jobs:
  # Determine which scan to run based on schedule
  determine-scan-type:
    runs-on: ubuntu-latest
    outputs:
      scan_type: ${{ steps.set-type.outputs.scan_type }}
    steps:
      - name: Determine scan type
        id: set-type
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "scan_type=${{ github.event.inputs.scan_type }}" >> $GITHUB_OUTPUT
          else
            # Determine based on cron schedule
            HOUR=$(date -u +%H)
            DAY=$(date -u +%d)
            DOW=$(date -u +%u)  # 1=Monday, 7=Sunday
            
            if [ "$DAY" = "01" ] && [ "$HOUR" = "08" ]; then
              echo "scan_type=monthly" >> $GITHUB_OUTPUT
            elif [ "$DOW" = "1" ] && [ "$HOUR" = "02" ]; then
              echo "scan_type=weekly" >> $GITHUB_OUTPUT
            elif [ "$HOUR" = "11" ]; then
              echo "scan_type=daily" >> $GITHUB_OUTPUT
            else
              echo "scan_type=hourly" >> $GITHUB_OUTPUT
            fi
          fi

  # Run the Eye Oracle scan
  run-oracle-scan:
    needs: determine-scan-type
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ‘ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ‘ï¸ Run Eye Oracle - ${{ needs.determine-scan-type.outputs.scan_type }}
        run: |
          echo "ğŸ‘ï¸ THE EYE ORACLE AWAKENS..."
          echo "ğŸ” Running ${{ needs.determine-scan-type.outputs.scan_type }} scan"
          npm run oracle:auto:${{ needs.determine-scan-type.outputs.scan_type }}

      - name: ğŸ“Š Generate reports
        if: needs.determine-scan-type.outputs.scan_type != 'hourly'
        run: |
          npm run oracle:generate || echo "Blog post already exists for today"

      - name: ğŸ”¥ Generate viral content
        if: needs.determine-scan-type.outputs.scan_type == 'daily'
        run: |
          npm run generate:viral || echo "Viral content generation skipped"

      - name: ğŸ“ Commit and push changes
        run: |
          git config --local user.email "eye-oracle@injuredworkersunite.ca"
          git config --local user.name "The Eye Oracle [Bot]"
          
          # Add all data files
          git add public/data/*.json || true
          git add logs/*.log || true
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            SCAN_TYPE="${{ needs.determine-scan-type.outputs.scan_type }}"
            DATE=$(date -u +%Y-%m-%d)
            git commit -m "ğŸ‘ï¸ Eye Oracle ${SCAN_TYPE^} Scan - ${DATE}

Automated investigation by The Eye Oracle.
Scan Type: ${SCAN_TYPE}
Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)

The Eye sees all. The Eye speaks truth."
            
            git push
          fi

      - name: ğŸ“¢ Create issue for critical alerts
        if: needs.determine-scan-type.outputs.scan_type != 'hourly'
        run: |
          # Check if there are critical alerts
          if [ -f "public/data/eye-oracle-scan-report.json" ]; then
            CRITICAL_COUNT=$(cat public/data/eye-oracle-scan-report.json | jq '.criticalAlerts | length' 2>/dev/null || echo "0")
            
            if [ "$CRITICAL_COUNT" -gt "0" ]; then
              echo "ğŸš¨ $CRITICAL_COUNT critical alerts detected!"
              # Could create GitHub issue here with gh CLI
            fi
          fi

  # Deploy to Cloudflare Pages (if daily or weekly)
  deploy:
    needs: [determine-scan-type, run-oracle-scan]
    if: needs.determine-scan-type.outputs.scan_type == 'daily' || needs.determine-scan-type.outputs.scan_type == 'weekly'
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ‘ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          ref: master  # Get latest changes

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build site
        run: npm run build
        env:
          STATIC_EXPORT: true

      - name: ğŸš€ Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: injured-workers-unite
          directory: out
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

  # Notify on failure
  notify-failure:
    needs: [run-oracle-scan]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: âŒ Notify failure
        run: |
          echo "Eye Oracle scan failed!"
          echo "Scan type: ${{ needs.determine-scan-type.outputs.scan_type }}"
          echo "Check logs for details."
