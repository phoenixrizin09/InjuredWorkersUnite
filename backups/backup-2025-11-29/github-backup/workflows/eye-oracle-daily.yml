name: ğŸ‘ï¸ Eye Oracle Daily

# Run The Eye Oracle blog generator daily
# Analyzes real documented corruption cases with The Eye v2.0
# Publishes investigative blog posts automatically

on:
  schedule:
    # Run daily at midnight UTC (7pm EST / 4pm PST)
    - cron: '0 0 * * *'
  
  # Allow manual trigger from Actions tab
  workflow_dispatch:

jobs:
  generate-oracle-post:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history for accurate date-based rotation
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ‘ï¸ Generate Eye Oracle Post
        run: |
          echo "ğŸ‘ï¸ THE EYE ORACLE AWAKENS..."
          node scripts/generate-eye-oracle-daily.js
          
          # Verify post was created
          if [ -f "public/data/eye-oracle-posts.json" ]; then
            echo "âœ… Eye Oracle post generated successfully"
            
            # Show post count
            POST_COUNT=$(node -p "JSON.parse(require('fs').readFileSync('public/data/eye-oracle-posts.json')).length")
            echo "ğŸ“Š Total Oracle posts: $POST_COUNT"
          else
            echo "âš ï¸  No posts file found"
          fi
      
      - name: ğŸ“ Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: 'ğŸ‘ï¸ Eye Oracle: Daily investigative post'
          file_pattern: 'public/data/eye-oracle-posts.json'
          commit_user_name: 'The Eye Oracle Bot'
          commit_user_email: 'eye-oracle@injuredworkersunite.com'
          commit_author: 'The Eye Oracle <eye-oracle@injuredworkersunite.com>'
      
      - name: ğŸ“Š Post Summary
        if: success()
        run: |
          echo "## ğŸ‘ï¸ Eye Oracle Post Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extract latest post details using node with proper escaping
          node -e "const fs = require('fs'); const posts = JSON.parse(fs.readFileSync('public/data/eye-oracle-posts.json', 'utf8')); if (posts.length > 0) { const latest = posts[0]; console.log('**Date:** ' + latest.metadata.date); console.log(''); console.log('**Title:** ' + latest.title); console.log(''); console.log('**Category:** ' + latest.metadata.category); console.log(''); console.log('**Severity:** ' + latest.metadata.severity.toUpperCase()); console.log(''); console.log('**Risk Score:** ' + latest.metadata.riskScore + '/100'); console.log(''); console.log('**People Affected:** ' + latest.metadata.affectedCount); console.log(''); console.log('**Financial Impact:** ' + latest.metadata.financialImpact); console.log(''); console.log('**Source:** [' + latest.metadata.source + '](' + latest.metadata.sourceUrl + ')'); }" >> $GITHUB_STEP_SUMMARY
      
      - name: âŒ Error Report
        if: failure()
        run: |
          echo "## âŒ Eye Oracle Generation Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The Eye Oracle daily post generation encountered an error." >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
