# 👁️ THE EYE ORACLE - Daily Automation
# 
# Runs daily at 6 AM ET (11:00 UTC) and 6 PM ET (23:00 UTC) to:
# 1. Generate Justice Report with violation analysis
# 2. Generate Eye Oracle posts
# 3. Generate viral content hooks
# 4. Update data files
# 5. Commit and push changes
#
# 🇨🇦 The Eye sees all. The Eye never sleeps.

name: Eye Oracle Daily Report

on:
  schedule:
    # Daily at 6 AM ET (11:00 UTC) - Morning report
    - cron: '0 11 * * *'
    # Daily at 6 PM ET (23:00 UTC) - Evening backup/update
    - cron: '0 23 * * *'
  
  # Manual trigger
  workflow_dispatch:
  
  # Also run on push to master (for testing)
  push:
    branches: [master]
    paths:
      - 'scripts/generate-*.js'
      - 'utils/real-data-generator.js'
      - '.github/workflows/eye-oracle-automation.yml'

permissions:
  contents: write

jobs:
  generate-daily-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: 👁️ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: 📥 Install dependencies
        run: npm ci
        continue-on-error: false

      - name: ⚖️ Generate Daily Justice Report
        run: |
          echo "⚖️ GENERATING DAILY JUSTICE REPORT..."
          node scripts/generate-daily-justice-report.js || echo "⚠️ Justice report had warnings"
          echo "✅ Justice report complete!"
        continue-on-error: true

      - name: 👁️ Generate Eye Oracle Daily Report
        run: |
          echo "👁️ THE EYE ORACLE AWAKENS..."
          node scripts/generate-eye-oracle-daily.js || echo "⚠️ Daily report generation had warnings"
          echo "✅ Daily report step complete!"
        continue-on-error: true

      - name: 📱 Generate Daily Viral Report
        run: |
          echo "📱 GENERATING VIRAL SOCIAL CONTENT..."
          node scripts/generate-daily-eye-viral-report.js || echo "⚠️ Viral report had warnings"
          echo "✅ Viral report complete!"
        continue-on-error: true

      - name: 🔥 Generate viral content hooks
        run: |
          node scripts/generate-viral-content.js || echo "⚠️ Viral content already generated or had warnings"
        continue-on-error: true

      - name: 📝 Commit and push changes
        run: |
          git config --local user.email "eye-oracle@injuredworkersunite.ca"
          git config --local user.name "The Eye Oracle [Bot]"
          
          # Add all data files
          git add public/data/*.json || true
          git add public/*.xml || true
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "✅ No changes to commit - data already up to date"
          else
            DATE=$(date -u +%Y-%m-%d)
            git commit -m "👁️ Eye Oracle Daily Report - ${DATE}"
            git push
            echo "✅ Changes pushed to repository"
          fi

      - name: 📊 Report Status
        run: |
          echo "════════════════════════════════════════════════════════════════"
          echo "👁️ EYE ORACLE DAILY AUTOMATION COMPLETE"
          echo "════════════════════════════════════════════════════════════════"
          echo "Date: $(date -u +%Y-%m-%d)"
          echo "Time: $(date -u +%H:%M:%S) UTC"
          echo ""
          echo "📊 DATA FILES:"
          if [ -f "public/data/eye-oracle-posts.json" ]; then
            POST_COUNT=$(cat public/data/eye-oracle-posts.json | jq 'length' 2>/dev/null || echo "?")
            echo "   👁️ Eye Oracle posts: ${POST_COUNT}"
          fi
          if [ -f "public/data/alerts.json" ]; then
            ALERT_COUNT=$(cat public/data/alerts.json | jq 'length' 2>/dev/null || echo "?")
            echo "   🚨 Active alerts: ${ALERT_COUNT}"
          fi
          if [ -f "public/data/blog-posts.json" ]; then
            BLOG_COUNT=$(cat public/data/blog-posts.json | jq 'length' 2>/dev/null || echo "?")
            echo "   📝 Blog posts: ${BLOG_COUNT}"
          fi
          echo ""
          echo "════════════════════════════════════════════════════════════════"
          echo "👁️ THE EYE SEES ALL. THE EYE NEVER SLEEPS."
          echo "════════════════════════════════════════════════════════════════"
