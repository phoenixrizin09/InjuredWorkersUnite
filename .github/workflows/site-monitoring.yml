name: Monitor Site Health

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Homepage
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://59047984.injuredworkersunite-rsr.pages.dev)
          if [ $response != 200 ]; then
            echo "::error::Homepage returned $response"
            exit 1
          fi
          echo "✓ Homepage: $response"
      
      - name: Check Sitemap
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://59047984.injuredworkersunite-rsr.pages.dev/sitemap.xml)
          if [ $response != 200 ]; then
            echo "::error::Sitemap returned $response"
            exit 1
          fi
          echo "✓ Sitemap: $response"
      
      - name: Check RSS Feeds
        run: |
          for feed in blog-rss.xml oracle-rss.xml alerts-rss.xml; do
            response=$(curl -s -o /dev/null -w "%{http_code}" https://59047984.injuredworkersunite-rsr.pages.dev/$feed)
            if [ $response != 200 ]; then
              echo "::error::$feed returned $response"
              exit 1
            fi
            echo "✓ $feed: $response"
          done
      
      - name: Check Data Freshness
        run: |
          # Download data summary
          curl -s https://59047984.injuredworkersunite-rsr.pages.dev/data/data-summary.json > summary.json
          
          # Check if file exists and is valid JSON
          if ! jq empty summary.json 2>/dev/null; then
            echo "::error::Invalid data-summary.json"
            exit 1
          fi
          
          echo "✓ Data files accessible"
      
      - name: Notify on Failure
        if: failure()
        run: |
          echo "::warning::Site health check failed - investigate immediately"
